<!--
Element which is meant to be extended by the service elements. It provides the
ajax functionality and other common actions between resources.

@element resource-service
@blurb Element which is meant to be extended by the service elements. It
  provides the ajax functionality and other common actions between resources.
@status alpha
-->

<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../core-ajax/core-ajax.html">

<polymer-element name="resource-service" attributes="resource baseUrl authToken" hidden>

  <template>

    <core-ajax
      id="ajaxGET"
      method="GET"
      url="{{baseUrl}}{{resource}}{{resourceUid}}"
      params="{{params}}"
      headers='{"Authorization": "Basic {{authToken}}"}'
      contentType="application/json"
      handleAs="json"
      on-core-response="{{onResponse}}"></core-ajax>

    <core-ajax
      id="ajaxPOST"
      method="POST"
      url="{{baseUrl}}{{resource}}{{resourceUid}}"
      params="{{params}}"
      headers='{"Authorization": "Basic {{authToken}}"}'
      contentType="application/json"
      handleAs="json"
      on-core-response="{{onResponse}}"></core-ajax>

    <core-ajax
      id="ajaxPUT"
      method="PUT"
      url="{{baseUrl}}{{resource}}{{resourceUid}}"
      params="{{params}}"
      headers='{"Authorization": "Basic {{authToken}}"}'
      contentType="application/json"
      handleAs="json"
      on-core-response="{{onResponse}}"></core-ajax>

    <core-ajax
      id="ajaxDELETE"
      method="DELETE"
      url="{{baseUrl}}{{resource}}{{resourceUid}}"
      params="{{params}}"
      headers='{"Authorization": "Basic {{authToken}}"}'
      contentType="application/json"
      handleAs="json"
      on-core-response="{{onResponse}}"></core-ajax>

  </template>

  <script>

    Polymer('resource-service', {

      /**
       * Fired when the requested resource(s) has been loaded from the API.
       *
       * Examples:
       *   events-loaded
       *   products-loaded
       *
       * @event <resource>-loaded
       */

       /**
       * Fired when a resource has been created.
       *
       * Examples:
       *   profiles-created
       *
       * @event <resource>-created
       */

       /**
       * Fired when a resource has been updated.
       *
       * Examples:
       *   profiles-updated
       *
       * @event <resource>-updated
       */

      eventsMethodsMap: {
        'GET': '-loaded',
        'POST': '-created',
        'PUT': '-updated',
        'DELETE': '-deleted'
      },

      getResourceUid: function(resourceUri) {
        var resourceUid = undefined;
        if (resourceUri !== undefined) {
          resourceUid = "/" + resourceUri.split('/')[4];
        }
        return resourceUid;
      },

      onResponse: function(event) {
        var method = event.currentTarget.method;
        var response = event.detail.response;
        if (response.length === undefined) {
          response = [response];
        }
        var eventName = this.resource + this.eventsMethodsMap[method];
        this.fire(eventName, response);
      },

      promise: function(ajax) {
        return new Promise(function(resolve, reject) {
          var req = ajax.go();
          req.onload = function() {
            // This is called even on 404 etc so check the status.
            if (req.status == 200) {
              // Resolve the promise with the response text.
              resolve(req.response);
            }
            else {
              // Otherwise reject with the status text which will hopefully be a meaningful error.
              reject(Error(req.statusText));
            }
          };
          // Handle network errors
          req.onerror = function() {
            reject(Error("Network Error"));
          };
        });
      },

      get: function(resourceUri) {
        this.resourceUid = this.getResourceUid(resourceUri);
        return this.promise(this.$.ajaxGET);
      },

      filter: function(params) {
        this.params = params;
        return this.promise(this.$.ajaxGET);
      }

    });

  </script>

</polymer-element>
